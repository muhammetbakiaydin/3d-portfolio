// --- New Design Tokens (refined) ---
$palette-a: #2DD4BF;
$palette-b: #60A5FA;
$palette-c: #A78BFA;

$glass-fill: rgba(255,255,255,0.08);
$holder-fill: rgba(255,255,255,0.14);

$border-outer: rgba(255,255,255,0.22);
$border-inner: rgba(255,255,255,0.45);
$border-holder-outer: rgba(255,255,255,0.38);
$border-holder-inner: rgba(255,255,255,0.55);

$blur-dock: 32px;
$blur-holder: 36px;
$blur-chip: 24px;

$radius-dock: 32px;
$radius-chip: 20px;

$shadow-dock: 0 10px 28px rgba(0,0,0,0.22);
$shadow-chip-hover: 0 4px 14px rgba(0,0,0,0.25), 0 1px 2px rgba(0,0,0,0.35);

$timing-spring: cubic-bezier(.2,.8,.25,1);
$timing-holder: 240ms $timing-spring;

$gradient-accent: linear-gradient(120deg, $palette-a, $palette-b, $palette-c);
@function accent-conic() {
  @return conic-gradient(from 0deg, $palette-a, $palette-b, $palette-c, $palette-a);
}

$noise: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'>\
<filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/></filter>\
<rect width='80' height='80' filter='url(%23n)' opacity='0.10'/></svg>");

@mixin glass-border($outer, $inner) {
  border: 1px solid $outer;
  box-shadow: inset 0 1px 0 $inner;
}

// --- Dock ---
.menu-glass-dock {
  position: fixed;
  left: 50%;
  bottom: clamp(12px, env(safe-area-inset-bottom) + 12px, 28px);
  transform: translateX(-50%);
  z-index: 50;
  max-width: 720px;
  min-width: 320px;
  width: fit-content;
  padding: 14px 22px;
  border-radius: $radius-dock;
  isolation: isolate;
  --holder-left: 0px;
  --holder-width: 0px;
  display: flex;

  .dock-bg {
    position: absolute;
    inset: 0;
    background: $glass-fill;
    backdrop-filter: blur($blur-dock) saturate(170%);
    -webkit-backdrop-filter: blur($blur-dock) saturate(170%);
    @include glass-border($border-outer, $border-inner);
    border-radius: inherit;
    overflow: hidden;
    box-shadow: $shadow-dock;
    &::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.28), rgba(255,255,255,0) 55%);
      pointer-events: none;
    }
    &::after {
      content: "";
      position: absolute;
      inset: 0;
      background: $noise;
      mix-blend-mode: overlay;
      opacity: .35;
      pointer-events: none;
    }
  }

  // Subtle outer gradient glow
  &::before {
    content: "";
    position: absolute;
    inset: -40px -80px;
    background:
      radial-gradient(circle at 35% 60%, rgba($palette-a,0.18), transparent 70%),
      radial-gradient(circle at 65% 40%, rgba($palette-c,0.18), transparent 72%);
    filter: blur(30px);
    pointer-events: none;
    opacity: .9;
  }
  &::after {
    content: "";
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle at 50% 50%, rgba($palette-b,0.18), transparent 65%);
    filter: blur(32px);
    pointer-events: none;
    opacity: .7;
    mix-blend-mode: normal;
  }

  @media (prefers-reduced-motion: reduce) {
    &::before,
    &::after {
      animation: none;
    }
  }
}

// --- List Layout ---
.dock-list {
  position: relative;
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  gap: 12px;
  align-items: stretch;
  min-height: 56px;
}

// --- Items / Buttons ---
.dock-item {
  flex: 1 1 0;
  display: flex;
}

.m-btn {
  --tilt-x: 0deg;
  --tilt-y: 0deg;
  position: relative;
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px 16px;
  min-height: 56px;
  border-radius: $radius-chip;
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur($blur-chip) saturate(160%);
  -webkit-backdrop-filter: blur($blur-chip) saturate(160%);
  @include glass-border($border-outer, rgba(255,255,255,0.2));
  font: 600 13px/1 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  letter-spacing: 0.2px;
  color: #111;
  overflow: hidden;
  transition:
    transform .45s $timing-spring,
    background .35s,
    box-shadow .4s,
    color .35s;

  transform: perspective(600px) rotateX(var(--tilt-x)) rotateY(var(--tilt-y));
  -webkit-tap-highlight-color: transparent;

  .btn-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    pointer-events: none;
  }
  .btn-ic {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    transition: transform .4s $timing-spring;
  }
  .btn-label {
    white-space: nowrap;
    transition: opacity .35s, transform .35s;
  }

  &:hover,
  &:focus-visible {
    background: rgba(255,255,255,0.1);
    transform:
      translateY(-2px)
      perspective(600px)
      rotateX(var(--tilt-x)) rotateY(var(--tilt-y)) scale(1.02);
    box-shadow: $shadow-chip-hover;
  }

  &:focus-visible {
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.85),
      0 0 0 4px rgba($palette-b,0.55);
  }

  &.is-active {
    color: #000;
    .btn-ic { transform: scale(1.04); }
  }

  // Ripple (white, softer, 450ms)
  .m-ripple {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle at center, rgba(255,255,255,0.3), rgba(255,255,255,0) 65%);
    opacity: 0;
    transform: scale(.2);
    pointer-events: none;
  }
  .m-ripple.run {
    animation: ripple .45s ease-out forwards;
  }
  @keyframes ripple {
    40% { opacity: .45; }
    100% { opacity: 0; transform: scale(1); }
  }
}

// --- Active Holder ---
.active-holder {
  position: absolute;
  top: 0;
  left: var(--holder-left);
  width: var(--holder-width);
  height: 100%;
  pointer-events: none;
  border-radius: $radius-chip;
  background: $holder-fill;
  backdrop-filter: blur($blur-holder) saturate(180%);
  -webkit-backdrop-filter: blur($blur-holder) saturate(180%);
  border: 1px solid $border-holder-outer;
  box-shadow: inset 0 1px 0 $border-holder-inner;
  transition:
    left $timing-holder,
    width $timing-holder,
    transform 320ms $timing-spring;
  transform-origin: center;
  overflow: hidden;

  // Subtle accent ring + glow
  &::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: accent-conic();
    opacity: .6;
    mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
    -webkit-mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
    mask-composite: exclude;
    -webkit-mask-composite: xor;
    pointer-events: none;
  }
  &::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background:
      radial-gradient(circle at 50% 50%, rgba($palette-b,0.18), transparent 70%),
      radial-gradient(circle at 30% 60%, rgba($palette-a,0.14), transparent 70%),
      radial-gradient(circle at 70% 40%, rgba($palette-c,0.14), transparent 70%);
    filter: blur(28px);
    opacity: .9;
    pointer-events: none;
  }

  &.arrive {
    animation: holder-pop .32s $timing-spring;
  }
  @keyframes holder-pop {
    0% { transform: scale(.96); }
    55% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
}

// Active button subtle inner ring (toned)
.m-btn.is-active::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: accent-conic();
  opacity: .25;
  mask: radial-gradient(circle at center, rgba(0,0,0,0) 58%, #000 59%);
  pointer-events: none;
}

// Dark theme adjustments
@media (prefers-color-scheme: dark) {
  .m-btn {
    color: #f5f7fa;
    background: rgba(255,255,255,0.07);
    &.is-active { color: #fff; }
  }
  .active-holder {
    background: rgba(255,255,255,0.17);
  }
  .menu-glass-dock .dock-bg {
    background: rgba(32,32,40,0.28);
  }
}

// Reduced motion: remove transform transitions
@media (prefers-reduced-motion: reduce) {
  .active-holder,
  .m-btn {
    transition: none !important;
    animation: none !important;
  }
}

// Mobile label visibility
@media (max-width: 480px) {
  .m-btn .btn-label {
    opacity: 0;
    transform: translateY(4px);
  }
  .m-btn.is-active .btn-label {
    opacity: 1;
    transform: translateY(0);
  }
  .menu-glass-dock {
    padding: 12px 18px;
    min-width: 0;
  }
}

// Backdrop-filter fallback
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))) {
  .menu-glass-dock .dock-bg,
  .m-btn,
  .active-holder {
    background: rgba(255,255,255,0.16);
    box-shadow: $shadow-dock;
  }
}

// Contrast assist
.m-btn {
  text-shadow: 0 1px 2px rgba(0,0,0,0.35);
}
    box-shadow: $shadow-strong;
  }
}

// High contrast ensures readability
@mixin force-contrast($sel) {
  #{$sel} {
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  }
}
@include force-contrast(".m-btn");
